#!/bin/bash

export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

############################################################
#
#       位置参量
#
############################################################
ARGUMENT1="$1"
ARGUMENT2="$2"
ARGUMENT3="$3"

set -eu
#set -x

if [[ "$(id -u)" != "0" ]]; then
        echo "Error: must run with root"
        exit 1
fi

############################################################
#
#       全局变量
#
############################################################
BACKUP_ROOT="/backup"
BACKUP_DIR="mysql"
BACKUP_TIME=$(date +"%Y-%m-%d-%H%M%S")
LOG_DIR="log"
LOG_FILE="backup-mysql.log"

COMMAND_LIST="mysql mysqld mysqldump mysqlbinlog mysqladmin"
MYSQL_ROOT="/usr/local/mysql"
MY_CNF="/root/.my.cnf"

############################################################
#
#       处理变量
#
############################################################
if [[ -z "$ARGUMENT1" ]]; then
        ARGUMENT1="full"
fi

if [[ -z "$ARGUMENT2" ]]; then
        ARGUMENT2="backup"
fi

if [[ -z "$ARGUMENT3" ]]; then
        ARGUMENT3="list"
fi

############################################################
#
#       MySQL
#
############################################################
# 检测指令
for COMMAND in ${COMMAND_LIST}; do
        
        if ( ! type -p "$COMMAND" &> /dev/null ) && [[ -x "${MYSQL_ROOT}/bin/${COMMAND}" ]]; then
                ln -s ${MYSQL_ROOT}/bin/${COMMAND} /usr/local/bin/${COMMAND}
        fi
        
done

# 设置密码
if [[ ! -s "$MY_CNF" ]]; then
        echo "[mysqldump]" >> "$MY_CNF"
        echo "user=root" >> "$MY_CNF"
        echo "password=" >> "$MY_CNF"
        
        echo "Warning: Setting the password in ~/.my.cnf"
        exit 1
fi

# 检测密码
if ( ! grep "^password=.." "$MY_CNF" &> /dev/null ); then
        echo "Error: Setting the password in ~/.my.cnf"
        exit 1
fi

############################################################
#
#       主要函数
#
############################################################
default()
{
        echo "backup-mysql: unrecognized option '$1'"
        
        echo "Usage: backup-mysql <incremental|full> <backup|restore> [list|DATE]"
        echo ""
        
        exit 1
}

# 完全备份
full_backup()
{
        mysqldump -u root --single-transaction --master-data=2 --routines --flush-logs --all-databases \
        > ${BACKUP_ROOT}/${BACKUP_DIR}/full-${BACKUP_TIME}.sql
}

# 完全恢复
full_restore()
{
        echo "full_restore $1"
}

# 增量备份
incremental_backup()
{
        echo "incremental_backup"
}

# 增量恢复
incremental_restore()
{
        echo "incremental_restore $1"
}

full_backup_list()
{
        echo "full_backup_list"
}

incremental_backup_list()
{
        echo "incremental_backup_list"
}

############################################################
#
#       主要操作
#
############################################################
mkdir -p ${BACKUP_ROOT}/{"$BACKUP_DIR","$LOG_DIR"}

# 删除空的完全备份
cd ${BACKUP_ROOT}/${BACKUP_DIR}

if [[ -n "$(ls | grep "^full[0-9\-]*.sql$" | sort -u | xargs)" ]]; then
        
        for FULL_BACKUP in $(ls | grep "^full[0-9\-]*.sql$" | sort -u | xargs); do
                
                if ( ! grep "^\-- CHANGE MASTER TO MASTER_LOG_FILE" "$FULL_BACKUP" &> /dev/null ); then
                        rm -rf "$FULL_BACKUP"
                fi
                
        done
        
fi

cd - &> /dev/null

case "$ARGUMENT1" in
        
        "full")
                
                case "$ARGUMENT2" in
                        
                        "backup")
                                full_backup 2>> ${BACKUP_ROOT}/${LOG_DIR}/${LOG_FILE}
                          ;;
                        
                        "restore")
                                
                                case "$ARGUMENT3" in
                                        
                                        "list")
                                                full_backup_list
                                          ;;
                                        
                                        20[1-3][0-9]-[0-1][0-9]-[0-3][0-9]-[0-9][0-9][0-9][0-9][0-9][0-9])
                                                full_restore "$ARGUMENT3"
                                          ;;
                                        
                                        *)
                                                default "$ARGUMENT3"
                                          ;;
                                        
                                esac
                                
                          ;;
                        
                        *)
                                default "$ARGUMENT2"
                          ;;
                        
                esac
                
          ;;
        
        "incremental")
                
                case "$ARGUMENT2" in
                        
                        "backup")
                                incremental_backup
                          ;;
                        
                        "restore")
                                
                                case "$ARGUMENT3" in
                                        
                                        "list")
                                                incremental_backup_list
                                          ;;
                                        
                                        20[1-3][0-9]-[0-1][0-9]-[0-3][0-9]-[0-9][0-9][0-9][0-9][0-9][0-9])
                                                incremental_restore "$ARGUMENT3"
                                          ;;
                                        
                                        *)
                                                default "$ARGUMENT3"
                                          ;;
                                        
                                esac
                                
                          ;;
                        
                        *)
                                default "$ARGUMENT2"
                          ;;
                        
                esac
                
          ;;
        
        *)
                default "$ARGUMENT1"
          ;;
        
esac
