#!/bin/bash

export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

############################################################
#
#       1.位置参量
#
############################################################
ARGUMENT1="$1"
ARGUMENT2="$2"
ARGUMENT3="$3"

set -eu
#set -x

echo_color()
{
        echo -e "\e[1m\e[40;$2m$1\e[0m"
}

echo_error()
{
        echo_color "$1" "31"
        exit 1
}

echo_warning()
{
        echo_color "$1" "33"
        sleep 5
}

if [[ "$(id -u)" != "0" ]]; then
        echo_error "Error: must run with root"
fi

if [[ -s "/usr/local/bin/myfunction.sh" ]]; then
        . /usr/local/bin/myfunction.sh
else
        echo_error "Error: myfunction.sh not found"
fi

############################################################
#
#       2.全局变量
#
############################################################
BACKUP_TIME="$CURRENT_TIME"
BACKUP_ROOT="/backup"
MYSQL_ROOT="/usr/local/mysql"
COMMAND_LIST="mysql mysqld mysqldump mysqlbinlog mysqladmin"
DIR_WARNING="Don't remove the directory"

############################################################
#
#       3.初始化
#
############################################################
# 创建目录
mkdir -p ${BACKUP_ROOT}/{"mysql-full","mysql-incremental","mysql-binlog","log"}
echo "$DIR_WARNING" > "${BACKUP_ROOT}/mysql-binlog/${DIR_WARNING}"

# 检测指令是否存在
for COMMAND in ${COMMAND_LIST}; do
        if ( ! type -p "$COMMAND" &> /dev/null ) && [[ -x "${MYSQL_ROOT}/bin/${COMMAND}" ]]; then
                ln -s ${MYSQL_ROOT}/bin/${COMMAND} /usr/local/bin/${COMMAND}
        fi
done

# 创建文件 .backup-mysql.conf
if [[ -s "/root/.backup-mysql.conf" ]]; then
        . /root/.backup-mysql.conf
else
        echo "MYSQL_USER=" > /root/.backup-mysql.conf
        echo "MYSQL_PASSWORD=" >> /root/.backup-mysql.conf
        echo_error "Error: Setting the user and password in /root/.backup-mysql.conf"
fi

# 检测用户是否为空
if [[ -z "$MYSQL_USER" ]]; then
        echo_error "Error: Setting the user in /root/.backup-mysql.conf"
fi

# 检测密码是否为空
if [[ -z "$MYSQL_PASSWORD" ]]; then
        echo_error "Error: Setting the password in /root/.backup-mysql.conf"
fi

# 创建文件 .my.cnf
cat > /root/.my.cnf <<-EOF
[client]
user=${MYSQL_USER}
password=${MYSQL_PASSWORD}
EOF

# 检测密码是否正确
BINLOG_STATUS=$(mysql -e "show variables like 'log_bin'")

# 检测二进制日志是否启用
if ( echo "$BINLOG_STATUS" | grep "log_bin.*OFF" &> /dev/null ); then
        echo_error "Error: The binary log is disabled"
fi

############################################################
#
#       4.次要函数
#
############################################################
show_master()
{
        if ( mysql -e "show master status" | grep "\.[0-9]\{6\}" &> /dev/null ); then
                local CURRENT_BINLOG=$(mysql -e "show master status" | grep "\.[0-9]\{6\}")
                
                local BINLOG_FILE=$(echo "$CURRENT_BINLOG" | awk '{ print $1 }')
                local BINLOG_POSITION=$(echo "$CURRENT_BINLOG" | awk '{ print $2 }')
                
                local BINLOG_POSTFIX=$(echo "$BINLOG_FILE" | awk -F. '{ print $NF }')
                local BINLOG_NAME=$(echo "$BINLOG_FILE" | sed "s/\.${BINLOG_POSTFIX}$//g")
        else
                echo_error "Error: variable is empty"
        fi
        
        if [[ "$1" == "file" ]]; then
                echo "$BINLOG_FILE"
        elif [[ "$1" == "position" ]]; then
                echo "$BINLOG_POSITION"
        elif [[ "$1" == "name" ]]; then
                echo "$BINLOG_NAME"
        elif [[ "$1" == "postfix" ]]; then
                echo "$BINLOG_POSTFIX"
        else
                echo "$CURRENT_BINLOG"
        fi
}

save_binlog()
{
        local BINLOG_NAME=$(show_master "name")
        local BINLOG_POSTFIX=$(show_master "postfix")
        local BINLOG_POSITION=$(show_master "position")
        
# 内容缩进只可以用制表符，不可以用空格
cat > ${BACKUP_ROOT}/mysql-binlog/.mysql.binlog <<-EOF
BINLOG_NAME="${BINLOG_NAME}"
BINLOG_POSTFIX="${BINLOG_POSTFIX}"
BINLOG_POSITION="${BINLOG_POSITION}"
EOF
}

############################################################
#
#       5.主要函数
#
############################################################
default()
{
        echo "backup-mysql: unrecognized option '$1'"
        
        echo "Usage: backup-mysql <full|incr> <backup|restore> [list|DATE]"
        echo ""
        
        exit 1
}

# 完全备份
full_backup()
{
        mysqldump --single-transaction --master-data=2 --routines --flush-logs --all-databases \
        > ${BACKUP_ROOT}/mysql-full/${BACKUP_TIME}.sql
        
        save_binlog
        
        sleep 1
}

# 完全恢复
full_restore()
{
        if [[ -s "${BACKUP_ROOT}/mysql-full/$1.sql" ]]; then
                mysql < ${BACKUP_ROOT}/mysql-full/$1.sql
                sleep 1
        else
                echo_error "Error: full backup does not exist"
        fi
}

# 完全恢复列表
full_restore_list()
{
        echo_color "MySQL Full Backup:" "34"
        echo ""
        
        ls_timefile "${BACKUP_ROOT}/mysql-full" "" ".sql" | awk -F. '{ print $1 }'
        echo ""
        
        exit 0
}

# 增量备份
incremental_backup()
{
        echo 11
}

# 增量恢复
incremental_restore()
{
        echo 22
}

# 增量恢复列表
incremental_restore_list()
{
        echo 33
}

############################################################
#
#       6.次要操作
#
############################################################

############################################################
#
#       7.主要操作
#
############################################################
if [[ -z "$ARGUMENT1" ]]; then
        ARGUMENT1="full"
fi

if [[ -z "$ARGUMENT2" ]]; then
        ARGUMENT2="backup"
fi

if [[ -z "$ARGUMENT3" ]]; then
        ARGUMENT3="list"
fi

case "$ARGUMENT1" in
        "full")
                case "$ARGUMENT2" in
                        "backup")
                                full_backup
                        ;;
                        
                        "restore")
                                case "$ARGUMENT3" in
                                        "list")
                                                full_restore_list
                                        ;;
                                        
                                        20[1-3][0-9]-[0-1][0-9]-[0-3][0-9]-[0-9][0-9][0-9][0-9][0-9][0-9])
                                                full_restore "$ARGUMENT3"
                                        ;;
                                        
                                        *)
                                                default "$ARGUMENT3"
                                        ;;
                                esac
                        ;;
                        
                        *)
                                default "$ARGUMENT2"
                        ;;
                esac
        ;;
        
        "incr")
                case "$ARGUMENT2" in
                        "backup")
                                incremental_backup
                        ;;
                        
                        "restore")
                                case "$ARGUMENT3" in
                                        "list")
                                                incremental_restore_list
                                        ;;
                                        
                                        20[1-3][0-9]-[0-1][0-9]-[0-3][0-9]-[0-9][0-9][0-9][0-9][0-9][0-9])
                                                incremental_restore "$ARGUMENT3"
                                        ;;
                                        
                                        *)
                                                default "$ARGUMENT3"
                                        ;;
                                esac
                        ;;
                        
                        *)
                                default "$ARGUMENT2"
                        ;;
                esac
        ;;
        
        *)
                default "$ARGUMENT1"
        ;;
esac

############################################################
#
#       8.结束语
#
############################################################
# 删除文件 .my.cnf
if [[ -f "/root/.my.cnf" ]]; then
        rm -rf /root/.my.cnf
fi

time_success
